<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Face Upload & Compress</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #000;
    color: #0f0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
  }
  h1 {
    margin-bottom: 20px;
  }
  video, canvas {
    border: 2px solid #0f0;
    border-radius: 12px;
    max-width: 100%;
  }
  .btn {
    margin: 10px;
    padding: 15px 30px;
    font-size: 1.2em;
    background: #0f0;
    color: #000;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
  }
  .btn:hover {
    transform: scale(1.05);
    background: #0c0;
  }
  #log {
    margin-top: 20px;
    max-width: 600px;
    word-wrap: break-word;
  }
  input[type=file] {
    display: none;
  }
</style>
</head>
<body>
<h1>Face Upload & Compress</h1>

<video id="video" autoplay playsinline width="400"></video>
<canvas id="canvas" style="display:none;"></canvas>

<div>
  <button class="btn" id="snapBtn">Snap Photo</button>
  <button class="btn" id="uploadBtn">Upload Existing Photo</button>
  <input type="file" id="fileInput" accept="image/*">
</div>

<div id="log">Status: waiting...</div>

<script>
import { db } from './firebaseConfig.js';
import { doc,setDoc} from 'https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js';
  
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const logEl = document.getElementById('log');
const snapBtn = document.getElementById('snapBtn');
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const studObj = JSON.parse(localStorage.getItem('currentUser'));

function log(msg) {
  logEl.innerText = msg;
}

// Start camera
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  } catch (err) {
    log('Error accessing camera: ' + err);
  }
}

// Snap photo from video
function snapPhoto() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  canvas.toBlob(blob => compressAndUpload(blob), 'image/jpeg', 0.7);
}

// Compress file to max 800KB
function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      let { width, height } = img;
      if (width > maxWidth) {
        height = (maxWidth / width) * height;
        width = maxWidth;
      }
      if (height > maxHeight) {
        width = (maxHeight / height) * width;
        height = maxHeight;
      }
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
    };
    img.src = URL.createObjectURL(file);
  });
}

// Upload to Cloudinary
async function uploadToCloudinary(blob) {
  const formData = new FormData();
  formData.append('file', blob);
  formData.append('upload_preset', 'verifo');

  log('Uploading...');
  try {
    const res = await fetch('https://api.cloudinary.com/v1_1/dykvuhosr/image/upload', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    studObj.referencePic = data.secure_url;
    localStorage.setItem("currentUser",studObj);
    const docm = doc(db,"UNIUYO",studObj.level,studObj.dept,studObj.regNm);
    await setDoc(docm,{
      referencePic : data.secure_url
    });
    console.log('Uploaded URL:', data.secure_url);
    log('Upload successful! URL: ' + data.secure_url);
  } catch (err) {
    log('Upload failed: ' + err);
  }
}

// Compress then upload
async function compressAndUpload(fileOrBlob) {
  let blob = fileOrBlob;
  if (!(fileOrBlob instanceof Blob)) {
    blob = await compressImage(fileOrBlob);
  }
  // Optional: further check size
  if (blob.size > 800*1024) {
    blob = await compressImage(blob, 600, 600, 0.6);
  }
  uploadToCloudinary(blob);
}

// Event listeners
snapBtn.onclick = snapPhoto;
uploadBtn.onclick = () => fileInput.click();
fileInput.onchange = () => compressAndUpload(fileInput.files[0]);

startCamera();
</script>
</body>
</html>
